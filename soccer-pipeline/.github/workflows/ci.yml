name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  release:
    types: [created]

jobs:
  # ── Unit Tests (no Docker, no FFmpeg) ─────────────────────────────────────
  unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          pip install pydantic structlog fastapi httpx starlette \
                      pytest pytest-mock pytest-cov anyio

      - name: Run unit tests
        run: |
          pytest tests/unit/ -m unit -v \
            --cov=src --cov-report=term-missing \
            --cov-fail-under=75

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
        if: always()

  # ── Integration Tests (requires FFmpeg) ───────────────────────────────────
  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'

    services:
      redis:
        image: redis:7-alpine
        ports: ["6379:6379"]
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          pip install pydantic structlog fastapi httpx starlette \
                      pytest pytest-mock pytest-cov anyio

      - name: Run integration tests
        env:
          NAS_MOUNT_PATH: /tmp/test-nas-source
          NAS_OUTPUT_PATH: /tmp/test-nas-output
          WORKING_DIR: /tmp/test-working
          CELERY_BROKER_URL: redis://localhost:6379/0
          CELERY_RESULT_BACKEND: redis://localhost:6379/1
        run: |
          mkdir -p /tmp/test-nas-source /tmp/test-nas-output /tmp/test-working
          pytest tests/integration/ -m integration -v

  # ── E2E Tests (full Docker Compose stack, release only) ───────────────────
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    needs: [unit, integration]

    steps:
      - uses: actions/checkout@v4

      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Set up Docker Compose
        run: |
          cp infra/.env.example infra/.env
          echo "NAS_MOUNT_PATH=/tmp/e2e-nas" >> infra/.env
          echo "NAS_OUTPUT_PATH=/tmp/e2e-output" >> infra/.env
          echo "WORKING_DIR=/tmp/e2e-working" >> infra/.env
          mkdir -p /tmp/e2e-nas /tmp/e2e-output /tmp/e2e-working

      - name: Start stack
        run: docker compose -f infra/docker-compose.yml --env-file infra/.env up -d --build
        working-directory: .

      - name: Wait for API
        run: |
          for i in $(seq 1 30); do
            curl -sf http://localhost:8080/health && break
            echo "Waiting... ($i)"
            sleep 3
          done

      - name: Run E2E tests
        env:
          API_URL: http://localhost:8080
        run: pytest tests/e2e/ -m e2e -v --timeout=600

      - name: Collect logs on failure
        if: failure()
        run: docker compose -f infra/docker-compose.yml logs --tail=100
