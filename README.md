# Soccer Video Processing Pipeline

Agent-based system that processes 4K soccer match recordings from a NAS and automatically produces:

- **Goalkeeper Reel** — every GK action (saves, distribution, one-on-ones)
- **Highlights Reel** — shots, goals, near-misses, great plays
- **Player Reel** *(Phase 2)* — on-demand reel for any outfield player

## Quick Start

```bash
# 1. Deploy (auto-detects NVIDIA GPU / Apple MPS / CPU, generates .env, starts stack)
make deploy
# or non-interactive: infra/scripts/setup.sh /mnt/nas/soccer /mnt/nas/output

# 2. Submit a match for processing
curl -X POST http://localhost:8080/jobs \
  -H "Content-Type: application/json" \
  -d '{"nas_path": "matches/game_2025_01_15.mp4", "reel_types": ["goalkeeper", "highlights"]}'

# 3. Monitor progress
open http://localhost:8080/ui   # Dashboard
```

### Deployment Modes

`make deploy` auto-detects hardware and picks the right mode:

| Mode | Hardware | Stack |
|------|----------|-------|
| **NVIDIA** | Linux + CUDA GPUs | Full Docker with GPU passthrough |
| **MPS** | Apple Silicon (M1/M2/M3/M4) | Redis in Docker, worker + API run natively |
| **CPU** | Fallback | Full Docker, CPU-only inference |

## Agent System

This project uses Claude Code's multi-agent architecture. Each subdirectory under `agents/` is an independent agent with its own `CLAUDE.md` context:

| Agent | `cd` command | Purpose |
|-------|-------------|---------|
| Architect | `cd agents/architect` | System design, ADRs, interface contracts |
| Developer | `cd agents/developer` | All source code in `src/` |
| SDET | `cd agents/sdet` | Tests, CI, quality gates |
| Video Analyst | `cd agents/video-analyst` | CV/ML models, event taxonomy |
| Pipeline Operator | `cd agents/pipeline-operator` | Infra, deployment, monitoring |

## Development

```bash
make setup              # Install Python deps
make deploy             # Auto-detect hardware, generate .env, start stack
make generate-fixtures  # Create synthetic test videos
make test-unit          # Fast tests, no infra needed
make test-integration   # Requires Docker
make check-nas          # Verify NAS connectivity
make check-gpu          # Verify NVIDIA GPU + container toolkit
```

## Architecture

```
NAS (read-only)          Processing Node              NAS (output)
├── matches/             ┌────────────────────┐       ├── output/
│   ├── game1.mp4  ──►  │  Watcher → Intake  │         │   ├── {job_id}/
│   └── game2.mp4        │  ↓                 │         │   │   ├── goalkeeper_reel.mp4
│                         │  Detection         │  ──►   │   │   └── highlights_reel.mp4
│                         │  (YOLO + ByteTrack)│         │   └── ...
│                         │  ↓                 │
│                         │  Segmentation      │
│                         │  ↓                 │
│                         │  Assembly (FFmpeg) │
│                         └────────────────────┘
```

## Key Design Decisions

- **Streaming-first**: Video never fully loaded into RAM
- **Idempotent**: Re-processing same file = identical output
- **GPU-optional**: NVIDIA CUDA, Apple MPS, or CPU — auto-detected at deploy time
- **NAS-safe**: Source files never modified

See `docs/architecture.md` (generated by Architect agent) for full design.
